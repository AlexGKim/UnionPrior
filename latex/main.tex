\documentclass[11pt,a4paper]{article}
\pdfoutput=1
\usepackage{jcappub}
\usepackage{natbib}
% \usepackage[T1]{fontenc} % if needed

%\usepackage{geometry}                		% See geometry.pdf to learn the layout options. There are lots.
%\geometry{letterpaper}                   		% ... or a4paper or a5paper or ... 
%\geometry{landscape}                		% Activate for rotated page geometry
%\usepackage[parfill]{parskip}    		% Activate to begin paragraphs with an empty line rather than an indent
%\usepackage{graphicx}				% Use pdf, png, jpg, or epsÂ§ with pdflatex; use eps in DVI mode
								% TeX will automatically convert eps --> pdf in pdflatex		
\usepackage{amssymb, amsmath}

%SetFonts

%SetFonts


\title{Unity ``Binned'' Prior}
\author[a]{Alex Kim}
\affiliation[a]{Lawrence Berkeley National Laboratory}
\emailAdd{agkim@lbl.gov}
%\date{}							% Activate to display a given date or no date

\abstract{
The Union3 ``Binned''-model posterior has been distributed for third-party cosmology analysis. The posterior prefers a large value of
$\Omega_M$, a small absolute value of $w_0$, and a negative $w_a$, but still accommodates  $\Lambda$CDM; the supernova data alone are not particularly constraining. 
The posterior is calculated for
a  prior that is not flat but rather has non-trivial structure in $\Omega_M$--$w_0$--$w_a$. 
The distributed posterior
and that for a prior that is flat in $\Omega_M$--$w_0$--$w_a$ are shifted relative to each other, but not
at a level that is  statistically significant. 
Users are urged to exercise caution when using a posterior to approximate a likelihood, particularly the exploring space
far from the Union3 best-fit.
}

\begin{document}
\maketitle

\section{Introduction}
Supernova, BAO, and CMB data are used to fit cosmological and dark-energy parameters in the DESI cosmology
analysis \cite{2024arXiv240403002D}.  The fit to the flat $w_0$--$w_a$ model is discrepant with the $\Lambda$CDM
model at the 3.5$\sigma$ level for the combination of DESI+CMB with Union3  \cite{2023arXiv231112098R}.
Similar level discrepancies are found for the Pantheon+ \cite{2022ApJ...938..113S} and the DES-SN5YR\footnote{Data available at \url{https://github.com/des-science/DES-SN5YR.}} supernova compilations.

%The DESI plus SN results have folks in a tizzy.  Talking with DESI and David it is clear that DESI is incorporating Union3
%into its analyses incorrectly albeit in a subtle way;  it is of interest to explore how misapplication
%of Union3 could affect  DESI $w_0$--$w_a$  fits.

The Union3 ``Binned''\footnote{This name is poorly chosen: there is no binning in this model.} model is designed to compress the Union3 supernova data for convenient use by the community.  
The  model distance modulus
is the sum of the distance modulus of $\Omega_M=0.3$  $\Lambda$CDM plus a second-order spline specified by node values
at a fixed set of 22 redshifts.  The priors on the node values are taken to be standard normal distributions\footnote{The Union3 preprint states that the prior is flat.  However David has found looking back at his code
that the prior is standard normal.}.  
The posterior of the nodes is provided to DESI as values of
$\mu = \mu_{\Lambda \text{CDM}}(z;\Omega_M=0.3) + n$ and the Hessian of the $n$ posterior,
where $z$ are the fixed redshifts of the spline and $n$ the node values at the posterior maximum.
In Union3, cosmological inference is not made from the ``Binned'' model but rather directly from physics-based models.

The DESI cosmology analysis takes the 22 $\mu$ values at the posterior maximum and treats them as data in the joint-probe analysis.  However, the likelihood for these data is never determined!
Indeed the likelihood is non-analytic and computationally challenging to map out.  Instead, the likelihood is assumed to be proportional
to the posterior.

The objectives of this note are to explore what the ``Binned''-model posterior can say about $w_0w_a\Lambda$CDM cosmology, which is not normally
fit with  supernova data alone,
and to explore how the posterior changes with a different prior. 

\section{Union3 ``Binned'' Model and Posterior}
Union3 considers several cosmological models, including  flat and open $\Lambda$CDM, $w$CDM, and $w_0w_a$CDM.
In addition to these standard models,  Union3 analyzes a ``Binned'' model where the  distance modulus
is the sum of the distance modulus of $\Omega_M=0.3$  $\Lambda$CDM plus a second-order spline specified by node values, $n$,
at a fixed set of 22 redshifts, $z$.  The distance modulus of this model has significantly more flexibility 
and hence retains more information about the underlying data compared to the physics-motivated models.
The model can be (approximately) viewed as the measurement of distance modulus at 22 redshifts.
It is this model that is used in the DESI analysis.

Union3 uses Bayesian statistics for parameter estimation; as such it requires 
priors on the node values. In the analysis presented in the paper, these priors are taken to be standard normal distributions
$\mathcal{N}(n,1)$.

The physics cosmologies (e.g.$w_0w_a$CDM)  are not embedded in the ``Binned'' model but 
they come close; any cosmology's distance moduli at the node redshifts can be exactly replicated by the ``Binned'' model, acknowledging that
there are
inconsistencies in between the nodes.  Neglecting this inconsistency, we say that the flat $w_0w_a$CDM model
is a subspace of the ``Binned'' model defined by the mapping
\begin{align}
	n &= f(\Omega_M, w_0, w_a; z) \\
	& \equiv \mu_{w_0 w_a \text{CDM}}(z;\Omega_M, w_0, w_a)  - \mu_{\Lambda \text{CDM}}(z;\Omega_M=0.3).
\end{align}

While the Union3 posterior (denoted as $p_U$) is for the 22-dimensional node space, it is of interest to examine the posterior values for the
subspace occupied by the $w_0w_a$CDM
model. 
Values of $\ln{p_U}$ (using the Hessian approximation given by the covariance matrix $C_U$) for a
set of $\Omega_M$--$w_0$--$w_a$ values.
 are presented as the red contours in Figure~\ref{fig:posterior}, where the contour levels are set to $\Delta \ln{p}=12.29$, which gives
a coverage probability of $(1-0.68)$ in 22 dimensions.
The largest $\ln{p_U}$ in $w_0w_a$CDM is a $\Omega_M\approx 0.425$, $w_0 \approx -0.55$, and $w_a \approx -3.7$. $\Lambda$CDM at $\Omega_M \approx 0.35$ is within the 68\% confidence region.
Supernova data alone prefer high $\Omega_M$, a low absolute value of $w_0$, and a negative $w_a$, but do not have
the constraining power to exclude standard cosmology.

\begin{figure}[htbp] %  figure placement: here, top, bottom, or page
   \centering
   \includegraphics[width=5.5in]{../contour.png} 
   \caption{Red: Contours of values of the Union3 posterior $\ln{p_U}+c$ for a
set of $\Omega_M$--$w_0$--$w_a$ values, where $c= 11\ln{(2\pi)} + 0.5\ln({\det{C_U})}$.  The constant $c$ contains the
normalization of the Normal distribution, so $\ln{p_U}+c$  is equivalent to  $-\chi^2/2$.   
   Blue: Contours of  $\ln{p_F}  +c  $, which represent the shape of the posterior with a flat DESI prior in  $\Omega_M$--$w_0$--$w_a$ space.   
   The maximum of the $\ln{p}_U$  ($\ln{p}_F)$ posterior in this space is shown as the red (blue) star.  (The absolute maxima
   lie outside this space.)
   The contour levels are set to $\Delta \ln{p}=12.29$ which gives
   a coverage probability of $(1-0.68)$ in 22 dimensions. 
   These plots should not be mistaken as posterior plots in  $\Omega_M, w_0, w_a$. 
   Points show the position of DESI's  BAO+CMB+Union3 flat $w_0w_a$ best-fit 
    and  $\Lambda$CDM.}
   \label{fig:posterior}
\end{figure}

The maximum $-\chi^2/2$ in the plotted space is $-10.33$.  While $w_0w_a\Lambda$CDM is allowed, it is important
to keep in mind that other regions of model space provide a better fit (e.g.\ where the posterior is maximized $\chi^2=0$). 

\section{Union3 Prior for $n$ in Terms of $\Omega_M$--$w_0$--$w_a$}
The Union3 prior for the ``Binned'' analysis is designed to keep distance moduli within  proximity to a reasonable
fiducial distance modulus function.  It is of interest to see what this prior defined in magnitude
space looks like in terms of the cosmological and dark-energy parameters.

The standard normal prior on the nodes $\mathcal{N}(a,1)$ corresponds to a prior in  $\Omega_M$--$w_0$--$w_a$ of
\begin{equation}
p(\Omega_M, w_0,w_a) = \mathcal{N}(f(\Omega_M, w_0, w_a; z),1)  \sqrt{\det{\left(J^T J\right)}},
\end{equation}
where $J$ is the Jacobian matrix of $f$ and $J^TJ$ is the Gram matrix.

\begin{figure}[htbp] %  figure placement: here, top, bottom, or page
   \centering
   \includegraphics[width=5.5in]{../result.png} 
   \caption{Surfaces of $\ln{p}(\Omega_M, w_0,w_a)$  for a grid of values
 $w_0$--$w_a$ and $\Omega_M$.    The star (in the upper-left plot) shows the location of the maximum.
   Points show the position of the BAO+CMB+Union3 flat $w_0w_a$ best-fit     and  $\Lambda$CDM.}
   \label{fig:priors}
\end{figure}

Surfaces   $\ln{p}(\Omega_M, w_0,w_a)$ values\ for a grid of $\Omega_M$--$w_0$--$w_a$ are shown in
Figure~\ref{fig:priors}.   The prior is not uniform in  $\Omega_M$--$w_0$--$w_a$.
The posterior shown in Figure~\ref{fig:posterior} has a different shape,
demonstrating that it is not being driven by the prior.  Nevertheless,
we will see in the next Section that a different reasonable prior can shift the posterior
by an appreciable amount.

%DESI uses the node mean values as the data and the posterior as is error matrix.
%From that perspective, Figure~\ref{fig:posterior} shows the on the $w_0$--$w_a$ manifold
%subspace
%and should not be mistaken as a plot of a posterior.
\section{Posterior for a Flat  $\Omega_M$--$w_0$--$w_a$  Prior}

Union3 could have used a different prior for the nodes, in particular one
that is flat in $\Omega_M$--$w_0$--$w_a$.
The DESI prior is $\Omega_M \in \mathcal{U}(0.01,0.99)$, $w_0 \in \mathcal{U}(-3,1)$, $w_a \in \mathcal{U}(-3,2)$.
This prior is related to the original posterior by
\begin{equation}
p_F(n) = \frac{p_U(n)}{(0.98)(4)(5) \mathcal{N}(n,1)  \sqrt{\det{\left(J^T J\right)}}}
\label{eq:flatprior}
\end{equation}
in the $w_0w_a$ space.

Outside that space a choice could be $p(n)=0$ under the assumption
of a flat $w_0w_a$ cosmology.  The resulting posterior, however, would not easily be incorporated into the DESI analysis
and valuable information form the SN data would be lost.
Preferable is a prior that is continuous over the full space and hence more applicable for DESI,
perhaps through analytic continuation of $\sqrt{\det{\left(J^T J\right)}}$ into the larger space.
The specific choice is not important as long as Eq.~\ref{eq:flatprior} holds.

Values of $\ln{p}_F$ are shown for  $\Omega_M$--$w_0$--$w_a$ as blue contours in Figure~\ref{fig:posterior}.\footnote{Keep in mind that the Gaussian approximation of $p_U$ may not characterize the true posterior at all points of
phase space including the most probable value of $p_F$.}
The largest $\ln{p_U}$ in $w_0w_a$CDM is a $\Omega_M\approx 0.475$, $w_0 \approx -0.425$, and $w_a \approx -5.9$. $\Lambda$CDM 
is within the 68\% confidence region.  This is a shift from the Union3 posterior, though both maxima are well within their counterpart
posterior's 68\% confidence regions.  An interesting feature is that the two posteriors have nearly the same values for $w_0$--$w_a$ when $\Omega_M=0.3$, the fiducial cosmology of the ``Binned'' model.

% The maximum $\ln{p_F}$ in the plotted region is $-9.41$.

\section{DESI}
DESI  adopts uniform priors for $\Omega_M$--$w_0$--$w_a$ in its cosmology analysis.
Nevertheless DESI approximates the Union3 likelihood with a posterior based on a prior that is not uniform in $\Omega_M$--$w_0$--$w_a$
and that is shown to be shifted relative to a posterior with a uniform prior.
Though the shift may be statistically insignificant in the context of the $w_0w_a$LCDM model using SN data only,  it could have an important effect in the joint analysis
where the larger parameter space plays a non-trivial role in breaking degeneracies.


What is the solution? The best thing would be to transport
the supernova-cosmology likelihood into the joint analysis (or conversely transport DESI data into Unity). 
This may not be a crazy idea, the likelihood is well documented
and I have seen the David's code and it is fairly straightforward.  David uses STAN  (HMC
with no U-Turn sampling) to run the MCMC.
Short of that, we should ask
David to run Union3 with a new prior considering that the Gaussian approximation may not accurately describe the provided posterior, 
What the new prior should be is something to think about.  


\bibliographystyle{JHEP}
\bibliography{apj-jour,ref}


\end{document}  